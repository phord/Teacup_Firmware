default: exponential

.PHONY: plot
.PHONY: exponential.plot exponential-v20000.plot exponential-a1000.plot

GNUPLOT_FLAGS = --persist -e "$(GNUPLOT_SCRIPT)"
GNUPLOT_SCRIPT = plot '$(@:.plot=.trace)'
GNUPLOT_SCRIPT +=   u 1:3 with steps t 'VelocityNext'
GNUPLOT_SCRIPT += , '' u 1:4 with steps t 'VelocityNow'
GNUPLOT_SCRIPT += , '' u 1:5 with lines t 'Position (ideal)'
GNUPLOT_SCRIPT += , '' u 1:(\$$5 - \$$6) with steps t 'Position error'
GNUPLOT_SCRIPT += , '' u 1:6 with steps t 'Position (actual)'

all: plot

exponential.trace: exponential
	./exponential > $@

exponential-a1000.trace: exponential
	./exponential --acceleration=1000 > $@

exponential-v20000.trace: exponential
	./exponential --acceleration=100000 --velocity=20000 --distance=500 > $@

test: exponential
	set -e ; \
	for DIST in 1 2 3 4 5 10 50 100 10000 100000 ; do \
	  for ACC in 10 20 50 1000 100000 1000000 ; do \
	     for VELO in 10 20 50 1000 100000 ; do \
	       if ! ./exponential --acceleration=$$ACC --velocity=$$VELO --distance=$$DIST > test.trace ; then \
			echo "./exponential --acceleration=$$ACC --velocity=$$VELO --distance=$$DIST " ; \
		         echo $(#mv test.trace test ; \
			 gnuplot $(GNUPLOT_FLAGS) ;) > /dev/null ;\
		fi ; \
	    done ; \
	  done ; \
	done

%.plot: %.trace
	gnuplot $(GNUPLOT_FLAGS)

exponential.plot exponential-v20000.plot exponential-a1000.plot: exponential.trace exponential-v20000.trace exponential-a1000.trace
	gnuplot $(GNUPLOT_FLAGS)

plot: exponential.plot exponential-v20000.plot exponential-a1000.plot

exponential: exponential.c $(MAKEFILE_LIST)
	gcc -ggdb -o exponential exponential.c -lm
