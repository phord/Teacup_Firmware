<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=windows-1252"></head>
<body>
		    <div>
	        <h1>Generate stepper-motor speed profiles in real time</h1>
	        <p>
	        <b>David Austin</b> - December 30, 2004</p>
	    </div><br>
	    <div>
	           <span style="font-family: verdana; font-size: 13px; color: #003366;">
<strong>A new algorithm for stepper-motor acceleration allows speed
profiles to be parameterized and calculated in real time. This algorithm
 can run on a low-end microcontroller using only simple fixed-point
arithmetic operations and no data tables. It develops an accurate
approximation for the timing of a linear ramp with constant acceleration
 and deceleration.</strong>
</span>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">It's commonly
thought that the timing of a linear speed ramp for a stepper motor is
too complex to be calculated in real time. The exact formula for the
step delay is in Equation 8. The solution has been to store the ramp
data in precompiled arrays, but this method is inflexible and wastes
memory. The alternative has been to use a more powerful and expensive
processor than otherwise needed or a high-level stepper-control IC. This
 article develops an accurate approximation that has been implemented in
  C using 24.8 fixed-point arithmetic on a mid-range PIC
microcontroller.
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Motor step signals
can be generated by a 16-bit timer-comparator module as commonly
integrated in microcontrollers. On the PIC, the CCP
(capture/compare/pwm) performs this function. It allows steps to be
timed to the resolution of one timer period. Each step advances the
motor by a constant increment, typically 1.8 degrees on a hybrid stepper
 motor.
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">The timer frequency
 should be as high as possible while still allowing long delays as the
motor is accelerated from stop. A timer frequency of 1MHz has been used.
 A maximum motor speed of 300rpm is then equivalent to a delay count of
1,000. It's necessary to have high timer resolution to give smooth
acceleration at high speed.
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Notation and basic formulas</strong></span><br>
Delay (sec) programmed by timer count <em><span style="font-family: times;">c</span></em>:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq1.gif"> Equation 1
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><em><span style="font-family: times;">f</span></em> = timer frequency (Hz).<br>
Motor speed <span style="font-family: times;">&#969;</span> (rad/sec) at fixed timer count <em><span style="font-family: times;">c</span></em>:
</span></p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq2.gif"> Equation 2
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><span style="font-family: times;">&#945;</span> = motor step angle (radian).<br>
1rad = 180/<span style="font-family: times;">&#960;</span> = 57.3deg. 1rad/sec = 30/<span style="font-family: times;">&#960;</span> = 9.55rpm.
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Acceleration <span style="font-family: times;">&#969;</span>' (rad/sec<sup>2</sup>) from adjacent timer counts <em><span style="font-family: times;">c</span></em>1 and <em><span style="font-family: times;">c</span></em>2:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq3.gif"> Equation 3
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Equation 3 assumes
fixed-count speed (Equation 2) at the midpoint of each step interval
(Equation 1), as on a linear ramp, Figure 1. Note that <span style="font-family: times;">&#969;</span>' resolution is inversely proportional to the cube of the speed.
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig1.gif"><br clear="all">
<strong>Figure 1:  Ramp geometry: move of <em><span style="font-family: times;">m</span></em>=12 steps</strong>
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Linear speed ramp—exact</strong></span><br>
On a linear ramp, acceleration <span style="font-family: times;">&#969;</span>' is constant, and speed <span style="font-family: times;">&#969;</span>(<em><span style="font-family: times;">t</span></em>) = <span style="font-family: times;">&#969;</span>'.<em><span style="font-family: times;">t</span></em>. Integration gives the motor shaft angle &#952;(<em><span style="font-family: times;">t</span></em>):
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq4.gif"> Equation 4
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><em><span style="font-family: times;">n</span></em> &#8805; 0 step number (real). When the shaft is at &#952; = <em><span style="font-family: times;">n</span></em>.&#945;, (integer <em><span style="font-family: times;">n</span></em>) it's time for the <em><span style="font-family: times;">n</span></em>th step pulse:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq5.gif"> Equation 5
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">The exact timer count to program the delay between the <em><span style="font-family: times;">n</span></em>th and (<em><span style="font-family: times;">n</span></em>+1)th pulses (<em><span style="font-family: times;">n</span></em> &#8805; 0) is:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq6.gif"> Equation 6
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">The initial count <em><span style="font-family: times;">c</span></em><sub>0</sub> factorizes out to give Equations 7 and 8:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq7.gif"> Equation 7
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq8.gif"> Equation 8
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Note that <em><span style="font-family: times;">c</span></em><sub>0</sub> sets the acceleration, proportional to (1/<em><span style="font-family: times;">c</span></em><sub>0</sub>)<sup>2</sup> .
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">In real-time,
Equation 8 would require calculation of a square-root for each step,
with the added problem of loss of precision by subtraction.
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Approximating linear ramp</strong></span><br>
Ratio of successive exact timer counts from Equation 8:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq9.gif"> Equation 9
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Taylor series:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq10.gif"> Equation 10
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Equation 11 is the second-order approximation to Equation 9 using Equation 10:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq11.gif"> Equation 11
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Equation 11 can be rearranged for faster calculation:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq12.gif"> Equation 12
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Finally, we can disconnect the physical step number, <em><span style="font-family: times;">i</span></em>, from the step number <em><span style="font-family: times;">n</span></em> on a ramp from zero, to give the general-purpose ramp algorithm shown in Equation 13. Here <em><span style="font-family: times;">n</span></em> determines the acceleration and increments with <em><span style="font-family: times;">i</span></em> for constant acceleration. To ramp up from stop, <em><span style="font-family: times;">n<sub>i</sub></span></em> = <em><span style="font-family: times;">i</span></em>, <em><span style="font-family: times;">i</span></em>=1,2, . . . :
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq13.gif"> Equation 13
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;">Negative <em><span style="font-family: times;">n</span></em>-values give deceleration. In particular, Equation 14, with <em><span style="font-family: times;">n<sub>i</sub></span></em> = <em><span style="font-family: times;">i</span></em> -  <em><span style="font-family: times;">m</span></em>, can be used to ramp any speed down to stop in the final steps of a move of <em><span style="font-family: times;">m</span></em> steps:
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq14.gif"> Equation 14
</span></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><strong>Table 1:  Accuracy of the step-delay approximation</strong>
</span></p>
<p>
</p>
<p>
</p><table cellpadding="5" cellspacing="0" border="1" width="400">
    <tbody>
        <tr valign="top">
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>Step n</strong></span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>Exact (9)</strong></span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>Approx (11)</strong></span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>Relative error</strong></span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">1</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.4142</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.6000</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.4485</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	2</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.7673</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.7778</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.0136</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	3</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.8430</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.8462</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.00370</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	4</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.8810</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.8824</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.00152</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	5</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9041</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9048</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">7.66E-4</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	6</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9196</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9200</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">4.41E-4</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	10</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9511</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9512</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">9.42E-5</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	100</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9950</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9950</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">9.38E-8</span>
            </td>
        </tr>
        <tr valign="top">
            <td align="right">
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">	1,000</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9995</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">0.9995</span>
            </td>
            <td>
            <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">9.37E-11</span>
            </td>
        </tr>
    </tbody>
</table>
<p></p>
<p>
</p>
<p>
<span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Accuracy of approximation</strong></span><br>
Table 1 shows that the approximation is accurate even at low step number <em><span style="font-family: times;">n</span></em> and relative error decreases with <em><span style="font-family: times;">n<sup>3</sup></span></em>. However, <em><span style="font-family: times;">n</span></em>=1 has a significant inaccuracy. The inaccuracy at <em><span style="font-family: times;">n</span></em>=1 can be handled in two ways:
</span></p>
<p>
</p>
<p>
</p>
<ul>
    <span style="font-family: verdana; font-size: 13px;">
    <li>Treat <em><span style="font-family: times;">n</span></em>=1 as a special case. Using <em><span style="font-family: times;">c</span></em>1 0.4056 <em><span style="font-family: times;">c</span></em>0 compensates for the inaccuracies at the start of the ramp and allows Equation 7 to be used to calculate <em><span style="font-family: times;">c</span></em>0.
    </li>
    <li>Ignore the inaccuracy. In place of Equation 7 use Equation 15:
    </li>
    </span></ul>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq15.gif"> Equation 15
    </span></p>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;">The first
alternative gives an almost perfect linear ramp. The second alternative
starts with a fast step. This is to the good, as it helps keep the motor
 moving between step pulses 0 and 1-and establishes the angle error
needed to generate torque. It also allows a wider range of accelerations
 to be generated with a 16-bit timer and has the advantage of
simplicity. It's therefore recommended to ignore the inaccuracy at <em><span style="font-family: times;">n</span></em>=1.
    </span></p>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig2.gif"><br clear="all">
    <strong>Figure 2: Stepper-motor speed ramp</strong>
    </span></p>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig3.gif"><br clear="all">
    <strong>Figure 3: Start of ramp detail</strong>
    </span></p>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig4.gif"><br clear="all">
    <strong>Figure 4: End of ramp detail</strong>
    </span></p>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;">Figures 2
through 4 compare the options for a target ramp from 0 to 120rpm in
1sec. For clarity, step changes in speed are shown, calculated from
Equation 2. The true profile should be close to a straight line.
    </span></p>
    <p>
    </p>
    <p>
    <span style="font-family: verdana; font-size: 13px;">2.<em><span style="font-family: times;">c</span></em>/(4.<em><span style="font-family: times;">n</span></em>+1) in Equation 12 could be approximated by <em><span style="font-family: times;">c</span></em>/2.<em><span style="font-family: times;">n</span></em>. Some effects would be:
    </span></p>
    <ul>
        <span style="font-family: verdana; font-size: 13px;">
        <li>The algorithm would still produce a linear ramp.
        </li>
        <li><em><span style="font-family: times;">c<sub>0</sub></span></em> would be closer to the "exact" value shown in Equation 7: 88.6% instead of 67.6% for the same ramp acceleration.
        </li>
        <li>A single equation like Equation 13 could no longer be used for both acceleration and deceleration.
        </li>
        </span></ul>
        <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Changes of acceleration</strong></span><br>
        From Equations 4 and 5 we can obtain an expression for the step number <em><span style="font-family: times;">n</span></em> as a function of speed and acceleration:
        </span>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq16.gif"> Equation 16
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;">Thus the number of steps needed to reach a given speed is inversely proportional to the acceleration:
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq17.gif"> Equation 17
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;">This makes it possible to change the acceleration at a point on the ramp by changing the step number <em><span style="font-family: times;">n</span></em> in the ramp algorithm Equation 13. Moreover, using signed <span style="font-family: times;">&#969;</span>' values results in signed <em><span style="font-family: times;">n</span></em>-values that behave correctly in the algorithm. Only <span style="font-family: times;">&#969;</span>' = 0 needs special handling.
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;">The <em><span style="font-family: times;">n</span></em>-value given by Equation 17 is correct for <em><span style="font-family: times;">t<sub>n</sub></span></em>. However <em><span style="font-family: times;">c<sub>n</sub></span></em> represents an average for the interval <em><span style="font-family: times;">t<sub>n</sub></span></em> .. <em><span style="font-family: times;">t<sub>n</sub></span><sub>+1</sub></em>. Equation 17 is usually adequate, but it's more accurate to add a half-step to <em><span style="font-family: times;">n</span></em>-values for use in the ramp algorithm:
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq18.gif"> Equation 18
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;">The numerical example shown in Table 2 changes acceleration from 10 to 5 and to -20rad/sec<sup>2</sup> from step 200. Complex speed profiles can be built up piecewise in this way.
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><strong>Table 2:  Acceleration changes</strong>
        </span></p>
        <p>
        </p>
        <p>
        </p><table cellpadding="2" cellspacing="0" border="1" width="400">
            <tbody>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>Step i</strong></span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>n<sub>i</sub></strong></span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>ci (13)</strong></span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong><span style="font-family: times;">&#969;</span>' (3)</strong></span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"><strong>notes</strong></span>
                    </td>
                </tr>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">198</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">198</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">2,813.067</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">&nbsp;</span>
                    </td>
                    <td>
                    <img alt="" src="StepperMotorSpeedProfiles_files/0501feat1table1.gif">
                    </td>
                </tr>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">199</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">199<br>
                    398.5<br>
                    -100.25</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">2,806.008</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">10</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">10.(199+.5) =<br>
                    5.(398.5+.5) =<br>
                    -20.(-100.25+.5)</span>
                    </td>
                </tr>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">200</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">399.5</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">2,803.498 </span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">5</span>
                    </td>
                    <td rowspan="2">
                    <img alt="" src="StepperMotorSpeedProfiles_files/0501feat1table2.gif">
                    </td>
                </tr>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">201</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;"> 400.5</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">2,799.001</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">5</span>
                    </td>
                </tr>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">200</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">-99.25</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">2,820.180</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">-20</span>
                    </td>
                    <td rowspan="2">
                    <img alt="" src="StepperMotorSpeedProfiles_files/0501feat1table3.gif">
                    </td>
                </tr>
                <tr valign="top">
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">201</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">-98.25</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">2,834.568</span>
                    </td>
                    <td>
                    <span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 13px;">-20</span>
                    </td>
                </tr>
            </tbody>
        </table>
        <p></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Deceleration ramp</strong></span><br>
        For a short move of <em><span style="font-family: times;">m</span></em> steps, where the up-ramp at <span style="font-family: times;">&#969;</span>'<sub>1</sub> meets the down-ramp at <span style="font-family: times;">&#969;</span>'<sub>2</sub> before max speed is reached, the step number <em><span style="font-family: times;">m</span></em> at which to start decelerating is, from Equation 17:
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq19.gif"> Equation 19
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><span style="font-family: times;">&#969;</span>'<sub>1</sub> = acceleration, <span style="font-family: times;">&#969;</span>'<sub>2</sub> = deceleration (positive). Round <em><span style="font-family: times;">n</span></em> to integer and calculate <em><span style="font-family: times;">c<sub>n</sub></span></em> .. <em><span style="font-family: times;">c<sub>m-1</sub></span></em> using Equation 14.
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;">In other cases, Equations 17 or 18 can be used to calculate the number of steps <em><span style="font-family: times;">n</span></em>2 needed to stop at deceleration <span style="font-family: times;">&#969;</span>'<sub>2</sub>, given that the present speed was reached at step <em><span style="font-family: times;">n</span></em>1 with acceleration <span style="font-family: times;">&#969;</span>'<sub>1</sub>. Round <em><span style="font-family: times;">n</span></em>2 to integer and calculate <em><span style="font-family: times;">c<sub>m-n<sub>2</sub></sub> .. c<sub>m-1</sub></span></em>  using Equation 14.
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Smooth shift to max speed</strong></span><br>
        The ideal speed profile would make a smooth transition from ramp acceleration <span style="font-family: times;">&#969;</span>' to max speed <span style="font-family: times;">&#969;</span><sub><em><span style="font-family: times;">max</span></em></sub>.
 Higher speed is possible by reducing the acceleration near the top of
the ramp, and you can avoid possible undesirable effects of a
discontinuity in acceleration.
        </span></p>
        <p>
        </p>
        <p>
        <span style="font-family: verdana; font-size: 13px;">There are several ways to achieve a smooth transition while still allowing real-time computation on a low-end processor:
        </span></p>
        <ul>
            <span style="font-family: verdana; font-size: 13px;">
            <li>Reduce <span style="font-family: times;">&#969;</span>' in stages, giving a piecewise linear transition.
            </li>
            <li>Add a power term to the denominator of the ramp algorithm.
            </li>
            <li>Scale the change from <em><span style="font-family: times;">c<sub>i</sub></span><sub></sub></em><sub>-1</sub> to <em><span style="font-family: times;">c<sub>i</sub></span></em> by a linear factor.
            </li>
            </span></ul>
            <span style="font-family: verdana; font-size: 13px;">Now let's compare these methods.
            </span>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><strong>Piecewise linear</strong><br>
            This method, shown in Figure 5, is very flexible. Any number of breaks can be used. A set of <span style="font-family: times;">&#969;</span>-values is chosen at which <span style="font-family: times;">&#969;</span>' is successively reduced. The ramp algorithm in Equation 13 is used. At each step, <em><span style="font-family: times;">n</span></em> is incremented, and if <span style="font-family: times;">&#969;</span> (or <em><span style="font-family: times;">c</span></em>) crosses a break value, <em><span style="font-family: times;">n</span></em> is recalculated.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig5.gif"><br clear="all">
            <strong>Figure 5: Piecewise</strong>
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">Figure 5 results from the <em><span style="font-family: times;">j</span></em>th break given by (<em><span style="font-family: times;">c</span></em>)<sub><em><span style="font-family: times;">j</span></em>=0</sub> = 3.<em><span style="font-family: times;">c<sub>min</sub></span></em>, (<em><span style="font-family: times;">c</span></em>)<sub><em><span style="font-family: times;">j</span></em></sub> = ((<em><span style="font-family: times;">c</span>)<sub></sub></em><sub><em><span style="font-family: times;">j</span></em>- 1</sub>+<em><span style="font-family: times;">c<sub>min</sub></span></em>)/2, (<em><span style="font-family: times;">n<sub>i</sub></span></em>)<sub><em><span style="font-family: times;">j</span></em></sub> = 1.375.(<em><span style="font-family: times;">n<sub>i</sub></span><sub></sub></em><sub>- 1</sub>+1), <em><span style="font-family: times;">j</span></em> = 1,2,..,7. (<em><span style="font-family: times;">c</span></em>)<sub><em><span style="font-family: times;">j</span></em></sub> = delay count at <em><span style="font-family: times;">j</span></em>th break, <em><span style="font-family: times;">c<sub>min</sub></span></em>, = delay count at <span style="font-family: times;">&#969;</span><sub>max</sub>.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><strong>Power term</strong><br>
            Equation 20 adds a power term to the denominator of the ramp algorithm (Equation 12):
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq20.gif"> Equation 20
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">At low speed (low step-number <em><span style="font-family: times;">n</span></em>), the power term <em><span style="font-family: times;">k</span></em><span style="font-size: 13px;">·</span><em><span style="font-family: times;">n<sup>p</sup></span></em> is negligible, so acceleration is constant. As speed rises, <em><span style="font-family: times;">k</span></em><span style="font-size: 13px;">·</span><em><span style="font-family: times;">n<sup>p</sup></span></em> starts to dominate, eventually reducing the acceleration to zero. A higher power <em><span style="font-family: times;">p</span></em> produces a sharper "knee." The approach to <span style="font-family: times;">&#969;</span><sub>max</sub> is asymptotic.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">The transition occurs around <em><span style="font-family: times;">k</span></em><span style="font-size: 13px;">·</span><em><span style="font-family: times;">n<sup>p</sup></span></em> =  4.<em><span style="font-family: times;">n</span></em>. This can be used to calculate an approximate value for the constant <em><span style="font-family: times;">k</span></em> from initial acceleration <span style="font-family: times;">&#969;</span>' and required max speed <span style="font-family: times;">&#969;</span><sub>max</sub>:
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq21.gif"> Equation 21
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">The graphs in Figure 6 use Equation 21 to calculate <em><span style="font-family: times;">k</span></em> for <em><span style="font-family: times;">p</span></em>=2,3,4,5. The curve falls short of <span style="font-family: times;">&#969;</span><sub>max</sub> for <em><span style="font-family: times;">p</span></em>=2 but <em><span style="font-family: times;">k</span></em> is good for higher powers.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig6.gif"><br clear="all">
            <strong>Figure 6: Power term, <em><span style="font-family: times;">p</span></em>=2,3,4,5</strong>
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><strong>Linear factor</strong><br>
            In this method we run the ramp algorithm (Equation 12) up to step <em><span style="font-family: times;">n</span></em>1 and then scale the changes in <em><span style="font-family: times;">c</span></em> by a factor that reduces from 1 at step <em><span style="font-family: times;">n</span></em>1 to 0 at step <em><span style="font-family: times;">n</span></em>2:
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq22.gif"> Equation 22
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig7.gif"><br clear="all">
            <strong>Figure 7: Linear factor</strong>
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">The acceleration curve is fairly linear and symmetrical over the transition. <span style="font-family: times;">&#969;</span><sub>max</sub> is reached in about twice the time taken with no transition, as shown in Figure 7. <span style="font-family: times;">&#969;</span><sub>max</sub> can be estimated by integrating a continuous version of Equation 22,
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq22a.gif">. We obtain:
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq23.gif"> Equation 23
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">Equation 23 is accurate for a wide range of parameters, including <em><span style="font-family: times;">n</span></em>1=0. It then simplifies to Equation 24 (compare with Equation 16):
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq24.gif"> Equation 24
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">In Figure 7, the linear factor method is applied with transition ranges starting at 0 and 30%, 50%, and 70% of <span style="font-family: times;">&#969;</span><sub>max</sub>.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">A linear-factor transition can also be applied to the downramp:
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1eq25.gif"> Equation 25
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">Step-number <em><span style="font-family: times;">n</span></em>3, the start of the transition from max speed to the down-ramp, is calculated as in the previous example. For a short move, <em><span style="font-family: times;">n</span></em>3=<em><span style="font-family: times;">n</span></em>2, calculated by Equation 19.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig8.gif"><br clear="all">
            <strong>Figure 8: Linear factor: dual transitions</strong>
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">Figure 8 shows examples with and without a section at <span style="font-family: times;">&#969;</span><sub>max</sub>: <em><span style="font-family: times;">m</span></em>=700, <span style="font-family: times;">&#969;</span>'<sub>1</sub> =10, <span style="font-family: times;">&#969;</span>'<sub>2</sub> = -20, <em><span style="font-family: times;">n</span></em>1=0, <em><span style="font-family: times;">n</span></em>2=432, <em><span style="font-family: times;">n</span></em>3=484; and <em><span style="font-family: times;">m</span></em>=500, <em><span style="font-family: times;">n</span></em>2=<em><span style="font-family: times;">n</span></em>3=333, other parameters unchanged.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Transition methods in sum</strong></span><br>
            The form of the transition curve is assumed to be less
important than ease of calculation and control of parameters,
particularly <span style="font-family: times;">&#969;</span><sub>max</sub> and the size of the transition region.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">The
piecewise-linear method is flexible and can be arranged to require no
more calculation than a simple ramp, and give a visually smooth speed
profile. It may not work with some sets of parameters, though.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">In the power-term method, the <em><span style="font-family: times;">k</span></em>-parameter is easily calculated from <span style="font-family: times;">&#969;</span><sub>max</sub>. Calculating the power term creates problems in fixed-point arithmetic, as values vary over a wide range.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">The linear-factor method is recommended as reliable and easy to calculate in fixed-point arithmetic. Because <span style="font-family: times;">&#969;</span><sub>max</sub>
 is reached at a known step number, the method is good for short moves
and can transition from acceleration to deceleration with no
discontinuity, as Figure 8 demonstrates. Starting the transition at <em><span style="font-family: times;">n</span></em>1=0 gives a narrow transition region, and it's straightforward to calculate <em><span style="font-family: times;">n</span></em>2 from <span style="font-family: times;">&#969;</span><sub>max</sub>.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;">The methods are compared in Figures 5 through 7.
            </span></p>
            <p>
            </p>
            <p>
            <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Implementation</strong></span><br>
            You can implement this stepper-control algorithm using a
PIC18F252 and a L6219. The L6219 stepper driver IC performs the
following functions:
            </span></p>
            <ul>
                <span style="font-family: verdana; font-size: 13px;">
                <li>Provides diode-protected H-bridge drives capable of 46V/750mA to the two motor windings
                </li>
                <li>Translates digital signals from the PIC to current direction in the motor windings (PHASE1, 2 inputs)
                </li>
                <li>Limits each winding current to 0, 33%, 67%, or 100%
of a preset value by chopping the drive to the H-bridge transistors
(inputs I01, I11, I02, I12)
                </li>
                </span></ul>
                <span style="font-family: verdana; font-size: 13px;">The maximum current is set by a current-sense resistor for each winding.
                </span>
                <p>
                </p>
                <p>
                <span style="font-family: verdana; font-size: 13px;">The
 L6219 doesn't have "step" and "direction" control lines like some
stepper control ICs. The winding phase sequence must be provided by the
PIC. This makes control slightly more complicated but gives extra
flexibility and reduces cost. It also means that the phase can be
restored easily on power-up.
                </span></p>
                <p>
                </p>
                <p>
                <span style="font-family: verdana; font-size: 13px;">By
using the I-inputs, the L6219 can be used for half- and quarter-step
operation. For full-step, they can be tied together and driven by one
GPIO from the PIC.
                </span></p>
                <p>
                </p>
                <p>
                <span style="font-family: verdana; font-size: 13px;">Microchip's
 PIC18F252 is a 28-pin device with the same footprint as the PIC16F876.
The more powerful core of the '252 makes it easier to program in C.
Figure 9 shows how the internal timing resources were configured for
controlling the L6219.
                </span></p>
                <p>
                </p>
                <p>
                <span style="font-family: verdana; font-size: 13px;"><img alt="" src="StepperMotorSpeedProfiles_files/0501feat1fig9.gif"><br clear="all">
                <strong>Figure 9: PIC18F252 timer configuration for L6219 interface</strong>
                </span></p>
                <p>
                </p>
                <p>
                <span style="font-family: verdana; font-size: 13px;">An 8MHz crystal and the PIC's <span style="font-size: 10px;">×</span>4
 PLL frequency multiplier are used to generate a 32MHz processor clock.
This is divided by four to clock the timers at 8MHz. Driving the motor
involves the following sequence:
                </span></p>
                <ol>
                    <span style="font-family: verdana; font-size: 13px;">
                    <li>Get parameters: step count, direction, delay count <em><span style="font-family: times;">c</span></em>0, max speed and so forth.
                    </li>
                    <li>Set up hardware: initialise CCP1 and CCP2, enable motor current, enable CCP1 interrupts.
                    </li>
                    <li>Service CCP1 interrupts: count the steps and execute a state machine to reconfigure the CCPs and calculate the next timer value.
                    </li>
                    <li>Clean up: after the last step, disable CCP1 interrupts, current off, flag the move done.
                    </li>
                    </span></ol>
                    <span style="font-family: verdana; font-size: 13px;">The listing (online at <a href="http://www.eetimes.com/design/embedded/source-code/4210291/Motor-c">http://www.eetimes.com/design/embedded/source-code/4210291/Motor-c</a>)
 is a minimal demo of these steps, with linear ramps, fixed maximum
speed and accelerations. The author used the CCS compiler. Minor changes
 will be required for other compilers.
                    </span>
                    <p>
                    </p>
                    <p>
                    <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Stepping out</strong></span><br>
                    The real-time algorithms I've explained here
significantly reduce the processing power needed for smooth speed
control of stepper motors. The linear ramp algorithm can be adapted to
piecewise linear speed profiles and smooth transitions from ramp to max
speed.
                    </span></p>
                    <p>
                    </p>
                    <p>
                    <span style="font-family: verdana; font-size: 13px;"><strong>David Austin</strong> is a freelance software engineer from Durham, U.K. You can reach him at <a href="mailto:dave@slotech.fsnet.co.uk">dave@slotech.fsnet.co.uk</a>.
                    </span></p>
                    <p>
                    </p>
                    <p>
                    <span style="font-family: verdana; font-size: 13px;"><span style="font-family: verdana,arial,helvetica,sans-serif; font-size: 16px; color: #003366;"><strong>Resources</strong></span><br>
                    Acarnley, Paul. <em>Stepping Motors— A Guide to Theory and Practice, 4th edition</em>. London: Institution of Electrical Engineers, 2002.
                    </span></p>
                    <p>
                    </p>
                    <p>
                    <span style="font-family: verdana; font-size: 13px;">Kenjo, Takashi and Akira Sugawara. <em>Stepping Motors and their Microprocessor Controls, 2nd edition</em>. Oxford University Press, March, 1995.
                    </span></p>
                    <p>
                    </p>
                    <p>
                    <span style="font-family: verdana; font-size: 13px;">Control of Stepping Motors— A Tutorial
                    <a href="http://www.cs.uiowa.edu/%7Ejones/step/">www.cs.uiowa.edu/~jones/step/</a>
                    </span></p>
                    <p>
                    </p>
                    <p>
                    <span style="font-family: verdana; font-size: 13px;"><strong>Suppliers' Web sites:</strong><br>
                    PIC18F252 <a href="http://www.microchip.com/">www.microchip.com</a><br>
                    L6219 <a href="http://www.st.com/">www.st.com</a><br>
                    PIC C compiler <a href="http://www.ccsinfo.com/">www.ccsinfo.com</a><br>
                    Stepper motors <a href="http://www.rotalink.com/">www.rotalink.com</a><br>
                    Mathcad (graphs) <a href="http://www.mathsoft.com/">www.mathsoft.com</a></span></p>	    </div>


</body></html>